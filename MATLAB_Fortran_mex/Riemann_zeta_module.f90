!Author: Alexey Kuznetsov
!York University, Toronto, Canada
!Website: https://kuznetsovmath.ca/
!Email: akuznets@yorku.ca
!
!Created: 1-Dec-2025
!Last updated: 5-Dec-2025  
!
!License: BSD 3-Clause (https://opensource.org/licenses/BSD-3-Clause)
!#######################################################################
module Riemann_zeta_module
	implicit none
	real(kind=16), parameter     :: pi_16=3.141592653589793238462643383279502884q0
	complex(kind=16), parameter  :: i_16=(0.0q0,1.0q0) 
contains
!#######################################################################
		function Riemann_zeta(s) result(f)
!--------------------------------------------------------------------------	
	implicit none
	complex (kind=16), intent(in)	:: s	
	complex (kind=16)		:: f	
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	if (s%re>=0.5q0) then
		f=Riemann_zeta_half_plane(s)
	else ! use reflection formula for the Riemann zeta function for Re(s)<0.5
		if (s%im>=0) then
			f=i_16*(2*pi_16)**(s-1)*(1-exp(i_16*pi_16*s))*exp(-0.5q0*i_16*pi_16*s&
				+ln_gamma(1-s))*Riemann_zeta_half_plane(1-s)
		else
			f=-i_16*(2*pi_16)**(s-1)*(1-exp(-i_16*pi_16*s))*exp(0.5q0*i_16*pi_16*s&
				+ln_gamma(1-s))*Riemann_zeta_half_plane(1-s)
		end if
	end if	
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	end function Riemann_zeta
!#######################################################################
	function Riemann_zeta_half_plane(s) result(f)
! computes zeta(s) in the half-plane Re(s)>=0.5
	implicit none
	complex (kind=16), intent(in)	:: s	
	complex (kind=16)		:: f
	real(kind=16)			:: N_sum, N_EM, N_12
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	N_sum=8*exp(45/max(s%re-1,0.5q0))/30  ! computational complexity of zeta_summation function -- counting the number of evaluations of k^{-s}
	N_EM=abs(s)/2+10		    ! computational complexity of zeta_Euler_Maclaurin function			
	N_12=sqrt(abs(s%im)/(2*pi_16))/2+50	! computational complexity of zeta_12 function
	if (abs(s%im)<150) then 
		if (s%re<4) then
			f=zeta_Euler_Maclaurin(s)
		else	
			if (N_sum<N_EM) then
				f=zeta_summation(s)
			else
				f=zeta_Euler_Maclaurin(s)
			end if
		end if
	elseif (s%im>=150) then 
		if (s%re<3) then
			f=zeta_12(s)
		else	
			if (N_sum<N_12) then
				f=zeta_summation(s)
			else
				f=zeta_12(s)
			end if
		end if
			
	else
		if (s%re<3) then
			f=conjg(zeta_12(conjg(s)))
		else	
			if (N_sum<N_12) then
				f=zeta_summation(s)
			else
				f=conjg(zeta_12(conjg(s)))
			end if
		end if
				
	end if
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	end function Riemann_zeta_half_plane
!#######################################################################	
	function zeta_summation(s) result(f)
! approximates the Riemann zeta function f=zeta(s)=\sum_{n=1}^{\infty} n^{-s} 	
! to have more efficient computation, we instead compute g(s)=((1-2^{-s})(1-3^{-s})(1-5^{-s})) zeta(s) 
! which is the Dirichlet series g(z)=\sum_{n>=1, gcd(n,30)=1} n^{-s} 
! this trick removes about three-quarters of the terms from the original sum \sum_{n=1}^{\infty} n^{-s}
! we truncate the Dirichlet series for g(z) at n=N*30
! for Re(s)>2 the error is smaller than (30*N)^(1-Re(s))
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	implicit none
	complex (kind=16), intent(in)	:: s
	complex (kind=16)		:: f
	integer, parameter 		:: k(1:8)=(/1, 7, 11, 13, 17, 19, 23, 29/) ! residue classes mod 30 that are co-prime to 30
	integer				:: N, j, l
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	N=floor(exp(45/(s%re-1))/30)  ! choose N so that the error is smaller than 10^{-19}
	f=0
	do j=1,8
		do l=0,N
			f=f+(k(j)+30*l)**(-s)
		end do
	end do
	f=f/((1-2**(-s))*(1-3**(-s))*(1-5**(-s)))
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	end function zeta_summation
!#######################################################################
	function RS_main_sum(s,N) result(f)
! computes the two main sums in the Riemann-Siegel formula: f(1)=\sum_{n=1}^{N} n^{-s} and f(2)=\sum_{n=1}^{N} n^{s-1}
! we remove almost 50% of terms from these sums by using the following result:
! denote F(x)=\sum_{1<=n<=x} n^{-s} and G(x)=\sum_{1<=2n+1<=x} (2n+1)^{-s}
! then F(x)=G(x)+2^{-s} G(x/2)+4^{-s} G(x/4)+8^{-s} G(x/8)+16^{-s} F(x/16)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
	complex (kind=16), intent(in)	:: s
	integer, intent(in)		:: N
	complex (kind=16)		:: f(1:2), g2(1:2), g4(1:2), g8(1:2), u
	integer				:: k
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	if (N<16) then
		f=1
		do k=2,N
			u=k**(-s)
			f(1)=f(1)+u
			f(2)=f(2)+1/(u*k)
		end do
	else
		f=1
		do k=2,(N/16)
			u=k**(-s)
			f(1)=f(1)+u
			f(2)=f(2)+1/(u*k)
		end do
		g8=1
		do k=1,((N/8)-1)/2
			u=(2*k+1)**(-s)
			g8(1)=g8(1)+u
			g8(2)=g8(2)+1/(u*(2*k+1))
		end do		
		g4=g8
		do k=((N/8)+1)/2,((N/4)-1)/2
			u=(2*k+1)**(-s)
			g4(1)=g4(1)+u
			g4(2)=g4(2)+1/(u*(2*k+1))
		end do
		g2=g4
		do k=((N/4)+1)/2,((N/2)-1)/2
			u=(2*k+1)**(-s)
			g2(1)=g2(1)+u
			g2(2)=g2(2)+1/(u*(2*k+1))
		end do
		u=2**(-s)
		f(1)=u**4*f(1)+u**3*g8(1)+u**2*g4(1)+(u+1)*g2(1)
		u=1/(u*2)
		f(2)=u**4*f(2)+u**3*g8(2)+u**2*g4(2)+(u+1)*g2(2)
		do k=((N/2)+1)/2,(N-1)/2
			u=(2*k+1)**(-s)
			f(1)=f(1)+u
			f(2)=f(2)+1/(u*(2*k+1))
		end do
	end if
	end function RS_main_sum		
!#######################################################################
	function zeta_Euler_Maclaurin(s) result(f)
	implicit none
	complex (kind=16), intent(in)	:: s
	complex (kind=16)		:: f, m
	integer				:: k, N, N2
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! computes zeta(s) via Euler-Maclaurin summation 
! we use formula (25.2.10) at https://dlmf.nist.gov/25.2 with n=25
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! precompute b(k)=B_{2k}/(2k)!, where B_{k} are Bernoulli numbers
   real(kind=16), parameter	:: b(1:25)=&	
   (/8.33333333333333333333333333333333293q-2,&
    -1.38888888888888888888888888888888893q-3,&
    3.30687830687830687830687830687830844q-5,&
    -8.26719576719576719576719576719577148q-7,&
    2.08767569878680989792100903212014440q-8,&
    -5.28419013868749318484768220217955963q-10,&
    1.33825365306846788328269809751291339q-11,&
    -3.38968029632258286683019539124944525q-13,&
    8.58606205627784456413590545042563573q-15,&
    -2.17486869855806187304151642386592068q-16,&
    5.50900282836022951520265260890226040q-18,&
    -1.39544646858125233407076862640635689q-19,&
    3.53470703962946747169322997780380424q-21,&
    -8.95351742703754685040261131811275565q-23,&
    2.26795245233768306031095073886817000q-24,&
    -5.74479066887220244526388198760702843q-26,&
    1.45517247561486490186626486727133221q-27,&
    -3.68599494066531017818178247990866798q-29,&
    9.33673425709504467203255515278564467q-31,&
    -2.36502241570062993455963519636984353q-32,&
    5.99067176248213430465991239681967181q-34,&
    -1.51745488446829026171081313586472285q-35,&
    3.84375812545418823222944529099024291q-37,&
    -9.73635307264669103526762127925048019q-39,&
    2.46624704420068095710640028028884984q-40/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
	N=floor(abs(s)/2)+10
	N2=N**2
	m=s/N
	f=0
	do k=1,25
		f=f+b(k)*m
		m=m*(s+2*k-1)*(s+2*k)/N2
	end do
	f=1+N**(-s)*(f+0.5q0+N/(s-1))
	do k=2,(N-1)
		f=f+k**(-s)
	end do
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
	end function zeta_Euler_Maclaurin
!#######################################################################
	function zeta_12(s) result(f)
! computes the approximation zeta_{12}(s) to the Riemann zeta function described in 
! [1] A. Kuznetsov, "Simple and accurate approximations to the Riemann zeta function", 2025,  https://arxiv.org/abs/2503.09519	
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  	
	implicit none
	complex (kind=16), intent(in)	:: s
	complex (kind=16)		:: f, f1, f2, s1, chi, I1, I2, g(1:2)
	real (kind=16)			:: M, u
	integer				:: k, j, N	
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   complex(kind=16), parameter	:: lambda(1:12)=&	
      (/(0.12666507030478299171328588879538q0,-0.10087636358615151558524566443202q0),&
	(0.25122099390287200219569569142124q0,-0.20405074409349581911004051031180q0),&
	(0.37405911972784972054636868358418q0,-0.31221281154087242842137513443055q0),& 
	(0.49776929817534881045635955701099q0,-0.42635960060301833679056058340141q0),&
	(0.62435778140713997700002673039044q0,-0.54572495512799403188584815398318q0),&
	(0.75466390867013388720749045161642q0,-0.66972935838659877528943507209541q0),&
	(0.88933701315173701350361581796676q0,-0.79869551590918500550023908781514q0),&         
	(1.02947832738015104394795537702100q0,-0.93374897103422687909199888577669q0),&              
	(1.17700666949730216301023441132388q0,-1.07684193858043548080679607396027q0),&
	(1.33525480422098724064095160659601q0,-1.23127339545247342505983081362199q0),&  
	(1.51071045858258192077553791057342q0,-1.40345091272949325437536665778861q0),&
	(1.72033314454678436509164855529537q0,-1.61022353225906768661496722514114q0)/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   complex(kind=16), parameter	:: omega0=(1.6098168692729432925346560422022541q-1,1.87823072277176154607044212350895q-2)
   complex(kind=16), parameter	:: omega(1:12)=&
      (/(1.4106875185404046965105645712788459q-1,3.02465842133145100446327863373405q-2),&   
	(8.8469767244257187866040969336291841q-2,4.46960624042180008692385694241609q-2),&   
	(3.5150310372194186343936296492476377q-2,3.66197739954210998843410055490889q-2),& 
	(8.1172398241584947575282044650705794q-3,1.78939741414190712284813334727467q-2),& 
	(6.7293124348065999744683947100109004q-4,5.92406929893300257148499876708815q-3),&  
	(-2.6231285561276628016088792543058718q-4,1.40952189832532584552807898212223q-3),&     
	(-1.2407125021539101474191351741328731q-4,2.37524498834962686368608234375620q-4),& 
	(-2.6548327944815849601557456533448347q-5,2.63187311599115470745428256223651q-5),& 
	(-3.2872693233000221851679206259221078q-6,1.60583114552664837555774293393550q-6),&                
	(-2.264607013792395805037591106325525q-7,2.30109385236452501550096833543338q-8),&               
	(-7.184384829748545261872001768132292q-9,-2.17226972533644575270298136976476q-9),&                
	(-6.032583864104558568614884445020897q-11,-5.85674035801747810623084784839811q-11)/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	! compute chi(s)=(2*pi)^s/(2*cos(pi*s/2)*gamma(s))
	chi=exp(s*log(2*pi_16)+0.5q0*pi_16*i_16*s-log(1+exp(pi_16*i_16*s))-ln_gamma(s))
	!compute the main sum
	N=floor(sqrt(s%im/(2*pi_16)))
	g=RS_main_sum(s,N) ! compute the main sums in the Riemann-Siegel formula
	!compute I1=I_{M,12}(s) and  I2=conjg(I_{M,12}(1-conjg(s)))
	M=N+0.5q0	
	I1=exp(-s*log(M))*(omega0+sum(omega*(exp(-2*pi_16*M*lambda-s*log(1+i_16*lambda/M))&
		+exp(2*pi_16*M*lambda-s*log(1-i_16*lambda/M)))))
	s1=1-conjg(s)	
	I2=conjg(exp(-s1*log(M))*(omega0+sum(omega*(exp(-2*pi_16*M*lambda-s1*log(1+i_16*lambda/M))&
		+exp(2*pi_16*M*lambda-s1*log(1-i_16*lambda/M))))))
	f=g(1)+chi*g(2)-0.5q0*(-1)**N*(I1+chi*I2)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~		
	end function zeta_12
!#######################################################################
	function ln_gamma(z) result(f)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 	
	implicit none
	complex(kind=16), intent(in)	:: z
	complex(kind=16)		:: f, w
	integer				:: k
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  complex(kind=16), parameter	:: c(1:10)=&  
  (/(-6.32899264378083954638419690213358305q-19,-5.02618515225831864524291125577114754q-19),&
    (9.00118789519049878055317954964612560q-16,1.18043955890013107152066865403796443q-15),&
    (-4.29204799869012678130788469868436316q-14,-4.66621190267878627507686221512522336q-13),&
    (-3.06993266002176329741933845106314762q-11,4.58256502470738272942404661111310553q-11),&
    (3.20896062831335555334601331074941425q-9,-8.45570160599064823800107884664011153q-10),&
    (-1.09470182714659777673083157232597235q-7,-5.24436125117097128364528129393000065q-8),&
    (1.47528847671109786357817665562717741q-6,-2.65586627509694548648297660078199290q-6),&
    (-5.50768797120583008282927935725546637q-6,5.81608431331109985941637330149412975q-5),&
    (4.31122232694993407331819857083550188q-4,1.11921275658933787495833864997198982q-3),&
    (-2.41037222250212947178816411812599360q-9,-4.21699693059619209244770449485032864q-9)/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   real(kind=16), parameter 	:: c_r(1:10)=&  
   (/-2.00169371367851077240921611133845440q-3,&   
     1.43128980975431349878973832819745521q-3,&  
     8.69393952658216645174904902551239677q-4,&   
     -5.41543864782889254528473496920294957q-4,&  
     -6.98972526780601311534472208134570921q-4,&   
     -6.02535738432353374274741775542021765q-4,& 
     -4.02426638590669366133087883380795036q-4,&
     -2.08082060765028076175427617315967047q-4,&   
     -7.51589218439833233388701348386165060q-5,&   
     -1.31214481570680189526382098899024992q-5/)   
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   complex(kind=16), parameter	:: lambda(1:10)=&  
   (/(6.15772691848436302117950334290956840q0,5.82678927522618136678128661545234970q0),& 
     (5.70615059581813427304565174124639501q0,4.57767378167759699020117820108089056q0),& 
     (5.30370779721225742665966313861552107q0,3.63037687497795980682021854514944400q0),& 
     (4.92088169519527369357869627612543856q0,2.84880842625788893914763257537801717q0),& 
     (4.54514250023857218026370650640521016q0,2.17931076980339710121742097822727628q0),& 
     (4.16751786754127005568543614893858217q0,1.59323074506298371504158985275637993q0),& 
     (3.77782853497654937912120172342150212q0,-1.07224418246785135369876203150328604q0),& 
     (3.35848914848803730410049013333407534q0,-6.01249735439710145730606107292408783q-1),& 
     (2.85117399421515274972075545340518913q0,1.58182551673758068922716182867928173q-1),& 
     (2.11951140814251496765423382357130447q0,-6.91198414476815744877210668869951012q-1)/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    
   real(kind=16), parameter	:: lambda_r(1:10)=&  
   (/2.21771976816897749191699587269624580q0,& 
    1.81418432423509982786230354779162763q0,& 
    1.64516199407584064978689467741899988q0,& 
    1.37707044937426736953581755343856311q0,& 
    1.27428377575649369564587907893861732q0,& 
    1.18984188810634545941949504290129028q0,& 
    1.12226750115995944208083314090584000q0,& 
    1.07035206271462406505484513395398115q0,& 
    1.03311805263012155459126730383420396q0,& 
    1.00981307264980725643979710105875975q0/)
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	if ((abs(z%im)>100).and.(abs(z%re)<100)) then !use Stirling's asymptotic formula
		w=z**(-2)
		f=(z-0.5q0)*log(z)-z+0.5q0*log(2*pi_16)+(1.0q0/12+w*(-1.0q0/360+w*(1.0q0/1260+&
			w*(-1.0q0/1680+w/1188))))/z
	else
		if (z%re>1.5q0) then
			f=sum(c/(z-1+lambda)**3+conjg(c)/(z-1+conjg(lambda))**3+c_r/(z-1+lambda_r)**3)  
			f=2*f+(z-0.5q0)*log(z)-z+1/(12*z)+0.5q0*log(2*pi_16)
		elseif (z%re>0.5q0) then ! use the functional equation log(Gamma(z))=log(Gamma(z+1))-log(z)	
			f=sum(c/(z+lambda)**3+conjg(c)/(z+conjg(lambda))**3+c_r/(z+lambda_r)**3)  
			w=z+1;
			f=(2*f+(w-0.5q0)*log(w)-w+1/(12*w)+0.5q0*log(2*pi_16))-log(z)
		elseif (z%im>=0.0q0) then ! use reflection formula
			w=2-z
			f=sum(c/(w-1+lambda)**3+conjg(c)/(w-1+conjg(lambda))**3+c_r/(w-1+lambda_r)**3)	
			f=log(1-z)-(2*f+(w-0.5q0)*log(w)-w+1/(12*w))+0.5q0*log(2*pi_16)+pi_16*i_16*(z-0.5q0)&
			-log(1-exp(2*pi_16*i_16*z))
		else 	 ! use reflection formula
			w=2-z
			f=sum(c/(w-1+lambda)**3+conjg(c)/(w-1+conjg(lambda))**3+c_r/(w-1+lambda_r)**3)	
			f=log(1-z)-(2*f+(w-0.5q0)*log(w)-w+1/(12*w))+0.5q0*log(2*pi_16)-pi_16*i_16*(z-0.5q0)&
			-log(1-exp(-2*pi_16*i_16*z))	
		end if
	end if	
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	end function ln_gamma
!#######################################################################
end module Riemann_zeta_module
